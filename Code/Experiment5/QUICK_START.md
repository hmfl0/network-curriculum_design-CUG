# Experiment 5 - 快速参考

## 启动命令
```bash
python Code/Experiment5/reliable_router.py
```

## 常用命令

| 输入 | 功能 | 示例 |
|------|------|------|
| `table` | 显示路由表 | `> table` |
| `send <ID> <MSG>` | 发送可靠消息 | `> send B "Hello World"` |
| `corrupt on` | 开启校验码篡改模拟 | `> corrupt on` |
| `corrupt off` | 关闭校验码篡改模拟 | `> corrupt off` |
| `loss on` | 开启丢包模拟 | `> loss on` |
| `loss off` | 关闭丢包模拟 | `> loss off` |
| `help` | 显示详细帮助 | `> help` |
| `exit` | 退出程序 | `> exit` |

## 工作流程

### 第1步：启动网络
```
请输入本机ID: A
请选择要激活的串口: all
```
等待15秒左右，程序会自动发现邻居并构建路由表。

### 第2步：查看路由表
```
> table
============================================================
当前路由表 (Distance Vector)
============================================================
目标         开销         下一跳       接口              
A          0          A          LOCAL          
B          1          B          COM3           
============================================================
```

### 第3步：发送消息
```
> send B "Test Message"
=== 开始可靠发送到 B ===
[TX] 发送 SYN (Seq=12345, 数据='Test Message')
[TX] SYN已发送 (尝试 1/3)... 等待SYN-ACK
[TX] 收到 SYN-ACK，会话已建立
=== 发送成功 ===
```

## 测试场景

### 场景A：正常通信（最简单）
```
> send B "Normal"
```
预期：立即成功

### 场景B：校验错误恢复
```
> corrupt on           # 开启校验错误模拟
> send B "Error Test" # 第一个包校验码错误，被丢弃
                      # 发送方超时3秒后自动重传
                      # 第二个包正确，成功
```
预期：最终成功，中间有3秒超时等待

### 场景C：丢包恢复
```
> loss on              # 开启丢包模拟
> send B "Loss Test"   # 第一个包被丢弃
                       # 发送方超时3秒后自动重传
                       # 第二个包成功
```
预期：最终成功，中间有3秒超时等待

### 场景D：多跳通信（3个节点：A-B-C）
```
> send C "Multi-hop"   # A→B→C 的中继转发
                       # 整个过程仍保证可靠
```
预期：成功，B充当中继转发

## 关键概念

### 停等协议（Stop-and-Wait）
- 发送一个包，**等待**对方的确认（ACK）
- 收到ACK后才能发送下一个包
- 超时未收到ACK → 重新**发送**（重传）
- 简单但低效的可靠传输方法

### CRC32校验码
- 对每个包的内容计算一个校验值
- 接收方验证校验码，如果不匹配则丢弃（模拟错误）
- 发送方检测到丢弃，会自动重传

### 超时重传
- 发送方等待3秒接收ACK
- 如果3秒内没收到ACK，认为包丢失了
- 自动重新发送同一个包
- 最多重试3次，3次都失败就放弃

### 序列号
- 每个包都有一个序列号
- 用于检测重复包和失序包
- 接收方根据序列号判断是否已经收到过这个包

## 故障排查

| 问题 | 可能原因 | 解决方案 |
|------|--------|--------|
| 发送失败 | 目标节点离线 | 检查对方是否启动，检查路由表 |
| 发送后等待很久 | 对方节点无响应 | 等待3秒会自动超时重传，共3次 |
| 校验失败 | 有错误发生 | 这是正常的，程序会自动处理 |
| 无法看到路由表 | 路由表还未收敛 | 等待15秒后再试 |
| 模拟不起作用 | 命令没输对 | 确保用 `corrupt on` 而不是其他格式 |

## 性能指标

- **可靠性**: 100%（通过重传保证）
- **平均延迟**: 
  - 正常: ~100ms
  - 有校验错误: ~3秒（超时重传）
  - 有丢包: ~3秒（超时重传）
- **吞吐量**: 低（停等协议特性）
- **最大重传次数**: 3次

## 协议帧格式

**运输层帧**:
```
源端口 | 目标端口 | 序列号 | 校验码 | 类型 | 数据
0      | 0        | 12345  | ABC.. | SYN  | Hello
```

**包类型说明**:
- `SYN`: 初始同步（发送方→接收方），携带数据
- `SYN-ACK`: 同步确认（接收方→发送方）
- `DAT`: 普通数据包
- `ACK`: 数据确认

## 实验提交清单

- [ ] 能正常启动程序
- [ ] 能建立网络拓扑（查看路由表）
- [ ] 能在同一条链路发送消息
- [ ] 能通过多跳转发发送消息
- [ ] 能通过模拟校验错误测试重传
- [ ] 能通过模拟丢包测试重传
- [ ] 最多能在3个节点间通信
- [ ] 理解停等协议的工作原理
- [ ] 理解超时重传的触发条件
- [ ] 理解接收端的序列号处理逻辑
