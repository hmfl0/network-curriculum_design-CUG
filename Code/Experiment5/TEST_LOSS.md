#!/usr/bin/env python3
"""
实验五测试脚本 - 验证模拟丢包功能
"""

import sys

def test_loss_simulation():
    """测试模拟丢包的流程"""
    print("""
=== 实验五 模拟丢包 测试指南 ===

模拟丢包 (loss on) 的工作原理：
1. 发送方设置 'loss on'
2. 发送方执行 'send B "test"'
3. 第一个包被模拟丢弃，发送方会显示:
   [Simulate] 模拟丢包 (本应发往 COM3)
4. 发送方等待3秒超时
5. 发送方自动重传第二次
6. 接收方收到第二次的包并回复ACK
7. 发送方收到ACK，显示:
   [TX] 收到 SYN-ACK，会话已建立
   === 发送成功 ===

关键日志观察点：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【发送端日志】
✓ [Simulate] 模拟丢包 (本应发往 COM3)
  └─ 这表示第一个包被丢弃了（虽然返回了发送成功）

✓ [TX] SYN已发送 (尝试 1/3)... 等待SYN-ACK
  └─ 等待ACK

✓ [TX] SYN超时，准备重传...
  └─ 3秒超时，准备重传

✓ [TX] SYN已发送 (尝试 2/3)... 等待SYN-ACK
  └─ 第二次发送

✓ [TX] 收到 SYN-ACK，会话已建立
  └─ 收到接收方的确认

✓ === 发送成功 ===
  └─ 最终成功

【接收端日志】
✓ [RX SYN] 新会话请求 来自A InitSeq=xxxxx: 消息内容
  └─ 只会显示一次（因为第一个包被丢弃了，接收端没收到）

✓     >>> [交付应用层] 消息内容
  └─ 消息被交付给应用层

✓ [RX ACK] 确认成功，停止重传
  └─ 接收方回复的ACK

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

详细测试流程：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

PC-A:
  > loss on
  ✓ 模拟丢包已开启 (下一次发送的包将被丢弃)
  
  > send B "Hello World"
  === 开始可靠发送到 B ===
  [TX] 发送 SYN (Seq=12345, 数据='Hello World')
  [Simulate] 模拟丢包 (本应发往 COM3)   ← 关键：第一个包被丢了
  [TX] SYN已发送 (尝试 1/3)... 等待SYN-ACK
  [TX] SYN超时，准备重传...              ← 3秒后超时
  [TX] SYN已发送 (尝试 2/3)... 等待SYN-ACK
  [RX ACK] 确认成功，停止重传
  === 发送成功 ===                        ← 最终成功

PC-B:
  [RX SYN] 新会话请求 来自A InitSeq=12345: Hello World
      >>> [交付应用层] Hello World       ← 消息显示
  [RX ACK] 确认成功，停止重传

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

常见问题排查：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Q: 为什么没有看到 [Simulate] 的日志？
A: 可能原因：
   1. 没有执行 'loss on' 命令
   2. 在错误的节点执行（应该在发送端执行）
   3. 命令格式错误（应该是 'loss on' 不是 'loss on' 空格）

Q: 为什么接收端看不到消息内容？
A: 已修复！现在接收端会显示:
   [RX SYN] 新会话请求 来自A InitSeq=xxxxx: 消息内容
   >>> [交付应用层] 消息内容

Q: 发送方显示失败了怎么办？
A: 可能是网络问题或接收方离线
   1. 确保B节点在运行
   2. 检查路由表 (table 命令)
   3. 确认两个节点通过串口连接

Q: 重传的包为什么也被接收方接收了？
A: 因为 'loss on' 只会模拟一次
   - 第一个包：被丢弃 [Simulate]
   - 第二个包：正常发送，被接收

Q: 可以模拟多次丢包吗？
A: 可以，每次执行 'loss on' 都会模拟下一个发送的包

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

验证模拟丢包成功的标志：
✓ 发送端显示 [Simulate] 模拟丢包
✓ 发送端等待3秒后自动重传
✓ 重传的包被接收端接收
✓ 接收端显示消息内容
✓ 最终显示 === 发送成功 ===

如果满足以上所有条件，模拟丢包功能工作正常！
""")

if __name__ == '__main__':
    test_loss_simulation()
